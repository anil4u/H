#!/bin/bash

echo
echo   "---------------   OS COMMAND INJECTION ATTACK --------------------"

pod=$(kubectl get pods -n notemaker | grep web-service | grep Running | head -1 | awk '{print $1}')
echo   "------ uploading attack.sh to $pod  ---"
kubectl cp attack.sh notemaker/$pod:/tmp/

websvc=$(getNginxURL)
[[ $? -ne 0 ]] && echo $websvc && exit $?

echo "-------- launching command injection attack --------"
success=$(curl -o responses/os-cmd-injection.html $websvc/tmp/attack.sh) 
success=$(grep -c 'App Firewall rule' responses/os-cmd-injection.html)

if [ "$success" == "0" ]; then
  echo "   >> OS COMMAND INJECTION attack succeeded"
  echo "!------------- OS COMMAND INJECTION ATTACK SUCCEEDED -------------"
else
  echo "   >> OS COMMAND INJECTION attack prevented"
  echo "----- open responses/fileUpResponse.html to vew resp ----"
  echo "------------- OS COMMAND INJECTION ATTACK FAILED  ----------------"
fi
echo


  
websvc=$(getNginxURL)
[[ $? -ne 0 ]] && echo $websvc && exit $?

echo "------------   OS COMMAND INJECTION ATTACK ---------------"
echo "-- launching OS command injection attack on http://$websvc"

curl -s -o responses/localfile-response.html "http://$websvc/tmp/"
success=$(grep -c "Request violates WAAS Firewall rule" responses/localfile-response.html)
if [ "$success" == "0" ]; then
  echo "   >> OS command injection attack succeeded"
  echo "!-------  OS COMMAND INJECTION ATTACK SUCCESSFUL ----------"
else
  echo "   >> OS command injection attack prevented"
  echo "---------   OS COMMAND INJECTION ATTACK FAILED   ----------"
fi
echo


